<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreeFold Connect Callback</title>
    <!-- TF Connect library loaded inline to avoid CSP issues -->
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
        <h2>Processing login...</h2>
        <p>Please wait while we complete your authentication.</p>
    </div>

    <script>
        console.log('ðŸ”„ TF Connect callback.html loaded!');
        console.log('ðŸ“ Current URL:', window.location.href);
        console.log('ðŸ”— Opener exists:', !!window.opener);
        
        async function handleCallback() {
            try {
                console.log('ðŸš€ Starting TF Connect callback processing...');
                
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const signedAttemptParam = urlParams.get('signedAttempt');
                const doubleNameParam = urlParams.get('doubleName');
                
                console.log('ðŸ“‹ URL Parameters:', {
                    signedAttempt: signedAttemptParam ? 'Present' : 'Missing',
                    doubleName: doubleNameParam
                });

                if (!signedAttemptParam) {
                    throw new Error('Missing signedAttempt parameter');
                }

                // Parse the signedAttempt
                const signedAttemptData = JSON.parse(decodeURIComponent(signedAttemptParam));
                const doubleName = signedAttemptData.doubleName || doubleNameParam;
                
                console.log('ðŸ” Parsed data:', {
                    doubleName,
                    hasSignedAttempt: !!signedAttemptData.signedAttempt
                });

                // Create profile object from the callback data
                const completeProfile = {
                    id: doubleName,
                    name: doubleName,
                    email: `${doubleName}@threefold.me`,
                    publicKey: 'extracted-from-signed-attempt', // TODO: Extract from signedAttempt
                    avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${doubleName}`
                };
                
                console.log('âœ… Created profile:', completeProfile);
                
                // Store result in localStorage for same-page redirect flow
                window.localStorage.setItem('tfconnect_auth_result', JSON.stringify({
                    success: true,
                    profileData: completeProfile,
                    timestamp: Date.now()
                }));

                console.log('âœ… Stored auth result in localStorage, redirecting to main app...');
                
                // Redirect back to main app
                const mainAppUrl = window.location.origin + '/';
                console.log('ðŸ”„ Redirecting to main app:', mainAppUrl);
                window.location.href = mainAppUrl;
                
            } catch (error) {
                console.error('TF Connect callback error:', error);
                
                // Store error result
                window.localStorage.setItem('tfconnect_auth_result', JSON.stringify({
                    success: false,
                    error: error.message || 'Authentication failed',
                    timestamp: Date.now()
                }));
                
                // Redirect back to main app even on error
                setTimeout(() => {
                    window.location.href = window.location.origin + '/';
                }, 2000);
            }
        }

        // Run the callback handler
        handleCallback();
    </script>
</body>
</html>
